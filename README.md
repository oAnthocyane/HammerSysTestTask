## API Endpoints

Все API endpoints доступны по пути `/api/`. Документация API доступна по адресам:

*   **Swagger UI:** `http://<хост>:<порт>/swagger/`
*   **ReDoc:** `http://<хост>:<порт>/redoc/`

### Аутентификация

#### 1. Отправка кода верификации

*   **URL:** `POST /api/auth/send-code/`
*   **Описание:** Отправляет 4-значный код верификации на указанный номер телефона. В реальной системе код был бы отправлен по SMS. В этой реализации код возвращается в ответе для тестирования.
*   **Тело запроса (Request Body):**

    ```json
    {
      "phone_number": "+79991234567" // Строка, номер телефона в международном формате, начинающийся с '+'
    }
    ```
*   **Успешный ответ (200 OK):**

    ```json
    {
      "message": "Код успешно отправлен", // Строка, сообщение о результате
      "phone_number": "+79991234567",   // Строка, номер телефона, на который отправлен код
      "code": "1234"                    // Строка, отправленный код (только для тестирования)
    }
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Неверный формат данных запроса (например, отсутствует `phone_number` или неверный формат номера).
        ```json
        {
          "status": "error",
          "code": "VALIDATION_ERROR",
          "message": "Неверные данные запроса",
          "details": {
            "phone_number": "Номер телефона должен начинаться с '+'"
          }
        }
        ```
    *   `500 Internal Server Error`: Ошибка генерации кода (например, не удалось создать уникальный код).
        ```json
        {
          "status": "error",
          "code": "CODE_GENERATION_ERROR",
          "message": "Не удалось сгенерировать уникальный verification код за 100 попыток"
        }
        ```

#### 2. Верификация кода

*   **URL:** `POST /api/auth/verify-code/`
*   **Описание:** Проверяет код верификации для указанного номера телефона. При успешной проверке аутентифицирует пользователя (создает нового или находит существующего) и устанавливает сессию.
*   **Тело запроса (Request Body):**

    ```json
    {
      "phone_number": "+79991234567", // Строка, номер телефона
      "code": "1234"                  // Строка, 4-значный код верификации
    }
    ```
*   **Успешный ответ (200 OK):**

    ```json
    {
      "id": 1,                          // Число, уникальный ID пользователя
      "phone_number": "+79991234567",  // Строка, номер телефона пользователя
      "invite_code": "A1B2C3",         // Строка, 6-значный инвайт-код пользователя
      "activated_invite_code": null,   // Строка или null, инвайт-код, активированный пользователем
      "created_at": "2024-05-21T10:00:00Z", // Строка, дата/время создания пользователя (ISO 8601)
      "is_new_user": true              // Булево, true если пользователь был создан при этом запросе
    }
    ```
*   **Ошибки:**
    *   `400 Bad Request`: Неверный формат данных запроса.
        ```json
        {
          "status": "error",
          "code": "VALIDATION_ERROR",
          "message": "Неверные данные запроса",
          "details": {
            "code": "Код не может быть пустым"
          }
        }
        ```
    *   `400 Bad Request`: Код истек.
        ```json
        {
          "status": "error",
          "code": "CODE_EXPIRED",
          "message": "Код истек"
        }
        ```
    *   `400 Bad Request`: Неверный код.
        ```json
        {
          "status": "error",
          "code": "INVALID_CODE",
          "message": "Неверный код"
        }
        ```
    *   `500 Internal Server Error`: Ошибка создания пользователя.
        ```json
        {
          "status": "error",
          "code": "USER_CREATION_ERROR",
          "message": "Ошибка создания пользователя",
          "details": {
            "error_details": "..." // Детали ошибки из IntegrityError
          }
        }
        ```

### Профиль пользователя

#### 3. Получение профиля пользователя

*   **URL:** `GET /api/profile/`
*   **Описание:** Возвращает информацию о текущем аутентифицированном пользователе, включая список его рефералов. Требует активной сессии (пользователь должен быть залогинен через `/auth/verify-code/`).
*   **Требуется аутентификация:** Да (через сессию)
*   **Успешный ответ (200 OK):**

    ```json
    {
      "id": 1,                           // Число, уникальный ID пользователя
      "phone_number": "+79991234567",   // Строка, номер телефона пользователя
      "invite_code": "A1B2C3",          // Строка, 6-значный инвайт-код пользователя
      "activated_invite_code": "X9Y8Z7", // Строка или null, инвайт-код, активированный пользователем
      "referrals": [                     // Массив строк, список номеров телефонов пользователей, которые активировали инвайт-код текущего пользователя
        "+79876543210",
        "+71112223344"
      ],
      "created_at": "2024-05-21T10:00:00Z" // Строка, дата/время создания (ISO 8601)
    }
    ```
*   **Ошибки:**
    *   `401 Unauthorized`: Пользователь не аутентифицирован.
        ```json
        {
          "status": "error",
          "code": "NOT_AUTHENTICATED",
          "message": "Необходима аутентификация"
        }
        ```
    *   `404 Not Found`: Пользователь не найден (например, если аккаунт был удален).
        ```json
        {
          "status": "error",
          "code": "USER_NOT_FOUND",
          "message": "Пользователь не найден"
        }
        ```

#### 4. Активация инвайт-кода

*   **URL:** `POST /api/profile/activate-invite/`
*   **Описание:** Позволяет пользователю активировать чужой инвайт-код. Каждый пользователь может активировать только один инвайт-код. После успешной активации возвращается обновленный профиль пользователя.
*   **Требуется аутентификация:** Да (через сессию)
*   **Тело запроса (Request Body):**

    ```json
    {
      "invite_code": "X9Y8Z7" // Строка, 6-значный инвайт-код для активации
    }
    ```
*   **Успешный ответ (200 OK):**

    ```json
    {
      "id": 1,                           // Число, уникальный ID пользователя
      "phone_number": "+79991234567",   // Строка, номер телефона пользователя
      "invite_code": "A1B2C3",          // Строка, 6-значный инвайт-код пользователя
      "activated_invite_code": "X9Y8Z7", // Строка, только что активированный инвайт-код
      "referrals": [                     // Массив строк, список рефералов (может быть пустым)
        // ... (если у пользователя уже были рефералы)
      ],
      "created_at": "2024-05-21T10:00:00Z" // Строка, дата/время создания
    }
    ```
*   **Ошибки:**
    *   `401 Unauthorized`: Пользователь не аутентифицирован.
        ```json
        {
          "status": "error",
          "code": "NOT_AUTHENTICATED",
          "message": "Необходима аутентификация"
        }
        ```
    *   `400 Bad Request`: Неверный формат данных запроса.
        ```json
        {
          "status": "error",
          "code": "VALIDATION_ERROR",
          "message": "Неверные данные запроса",
          "details": {
            "invite_code": "Инвайт-код не может быть пустым"
          }
        }
        ```
    *   `400 Bad Request`: Инвайт-код уже был активирован пользователем.
        ```json
        {
          "status": "error",
          "code": "INVITE_ALREADY_ACTIVATED",
          "message": "Инвайт-код уже активирован"
        }
        ```
    *   `400 Bad Request`: Попытка использовать свой собственный инвайт-код.
        ```json
        {
          "status": "error",
          "code": "SELF_INVITE_NOT_ALLOWED",
          "message": "Нельзя использовать свой собственный инвайт-код"
        }
        ```
    *   `400 Bad Request`: Указанный инвайт-код не существует.
        ```json
        {
          "status": "error",
          "code": "INVALID_INVITE_CODE",
          "message": "Неверный инвайт-код"
        }
        ```
    *   `404 Not Found`: Пользователь не найден.
        ```json
        {
          "status": "error",
          "code": "USER_NOT_FOUND",
          "message": "Пользователь не найден"
        }
        ```
